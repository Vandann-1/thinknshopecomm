{% extends 'components/includes/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    'sans': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                }
            }
        }
    }
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        -webkit-tap-highlight-color: transparent;
    }
    
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.813rem;
        font-weight: 500;
        border: 1px solid;
        white-space: nowrap;
    }
    
    .status-pending { 
        background-color: #fff7ed; 
        color: #c2410c; 
        border-color: #fed7aa; 
    }
    .status-confirmed { 
        background-color: #eff6ff; 
        color: #1e40af; 
        border-color: #bfdbfe; 
    }
    .status-processing { 
        background-color: #eef2ff; 
        color: #4338ca; 
        border-color: #c7d2fe; 
    }
    .status-shipped { 
        background-color: #faf5ff; 
        color: #7c3aed; 
        border-color: #e9d5ff; 
    }
    .status-delivered { 
        background-color: #f0fdf4; 
        color: #15803d; 
        border-color: #bbf7d0; 
    }
    .status-cancelled { 
        background-color: #fef2f2; 
        color: #b91c1c; 
        border-color: #fecaca; 
    }
    
    .timeline-container {
        position: relative;
    }
    
    .timeline-item {
        display: flex;
        gap: 1rem;
        padding-bottom: 1.5rem;
        position: relative;
    }
    
    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 1rem;
        top: 2rem;
        width: 2px;
        height: calc(100% - 1rem);
        background-color: #e5e5e5;
    }
    
    .timeline-item.completed:not(:last-child)::after {
        background-color: #000;
    }
    
    .timeline-icon {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        border: 2px solid #d4d4d4;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        z-index: 10;
        position: relative;
    }
    
    .timeline-icon.completed {
        border-color: #000;
        background-color: #000;
        color: #fff;
    }
    
    .timeline-icon.cancelled {
        border-color: #dc2626;
        background-color: #dc2626;
        color: #fff;
    }
    
    .item-card {
        display: flex;
        gap: 0.75rem;
        padding: 1rem;
        border: 1px solid #f5f5f5;
        border-radius: 0.75rem;
        background-color: #fafafa;
        transition: all 0.2s ease;
    }
    
    .item-card:hover {
        border-color: #e5e5e5;
        background-color: #fff;
    }
    
    .item-image {
        width: 4.5rem;
        height: 4.5rem;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 1px solid #e5e5e5;
        flex-shrink: 0;
    }
    
    .modal-backdrop {
        backdrop-filter: blur(8px);
        animation: fadeIn 0.2s ease;
    }
    
    .modal-content {
        animation: slideUp 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        border: none;
        cursor: pointer;
        white-space: nowrap;
    }
    
    .btn-primary {
        background-color: #000;
        color: #fff;
    }
    
    .btn-primary:hover:not(:disabled) {
        background-color: #262626;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-secondary {
        background-color: #fff;
        color: #000;
        border: 1px solid #e5e5e5;
    }
    
    .btn-secondary:hover:not(:disabled) {
        background-color: #fafafa;
        border-color: #d4d4d4;
    }
    
    .btn-danger {
        background-color: #dc2626;
        color: #fff;
    }
    
    .btn-danger:hover:not(:disabled) {
        background-color: #b91c1c;
    }
    
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .card {
        background-color: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 1rem;
        padding: 1.5rem;
    }
    
    @media (max-width: 640px) {
        .card {
            padding: 1rem;
            border-radius: 0.75rem;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
        }
        
        .timeline-icon {
            width: 1.75rem;
            height: 1.75rem;
        }
        
        .timeline-item {
            gap: 0.75rem;
            padding-bottom: 1.25rem;
        }
        
        .timeline-item:not(:last-child)::after {
            left: 0.875rem;
        }
        
        .item-image {
            width: 3.5rem;
            height: 3.5rem;
        }
        
        .item-card {
            gap: 0.625rem;
            padding: 0.75rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.813rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
       
        <!-- Order Header -->
        <div class="card mb-4 sm:mb-6">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                <div class="flex-1 min-w-0">
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-2 sm:mb-3">
                        Order #{{ order.order_id }}
                    </h1>
                    
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <span class="status-badge status-{{ order.status }}">
                            {{ order.get_status_display }}
                        </span>
                        
                        {% if order.payment_status == 'paid' %}
                            <span class="status-badge" style="background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0;">
                                Payment Completed
                            </span>
                        {% elif order.payment_status == 'failed' %}
                            <span class="status-badge" style="background-color: #fef2f2; color: #b91c1c; border-color: #fecaca;">
                                Payment Failed
                            </span>
                        {% elif order.payment_status == 'pending' %}
                            <span class="status-badge" style="background-color: #fefce8; color: #a16207; border-color: #fde68a;">
                                Payment Pending
                            </span>
                        {% endif %}
                    </div>
                    
                    <p class="text-sm text-gray-600">
                        Placed on {{ order.created_at|date:"F d, Y \a\t g:i A" }}
                    </p>
                </div>
                
                <!-- Actions -->
<div class="flex flex-col sm:flex-row gap-2 lg:flex-shrink-0">
    {% if can_cancel %}
        <button onclick="cancelOrder()" 
                class="btn bg-black text-white px-4 py-2 rounded-md font-semibold shadow-md transition duration-300 hover:bg-gray-800">
            Cancel Order
        </button>
    {% endif %}
                    
                    {% if order.payment_status == 'paid' %}
                        <a href="{% url 'download_invoice' order.order_id %}" class="btn btn-secondary">
                            Download Invoice
                        </a>
                    {% endif %}
                    
                    {% if order.status == 'delivered' %}
                        <a href="{% url 'orders:reorder' order.order_id %}" class="btn btn-primary">
                            Reorder Items
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-4 sm:space-y-6">
                
                <!-- Order Items -->
                <div class="card">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4">
                        Order Items <span class="text-gray-500 font-normal">({{ order_summary.item_count }})</span>
                    </h2>
                    
                    <div class="space-y-3">
                        {% for item in order.items.all %}
                            <div class="item-card">
                                <!-- Image -->
                                <div class="flex-shrink-0">
                                    {% if item.variant.image %}
                                        <img src="{{ item.variant.image.url }}" alt="{{ item.product_name }}" class="item-image">
                                    {% elif item.product.get_primary_image %}
                                        <img src="{{ item.product.get_primary_image }}" alt="{{ item.product_name }}" class="item-image">
                                    {% else %}
                                        <div class="item-image bg-gray-100 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Details -->
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-gray-900 text-sm sm:text-base mb-1">
                                        {{ item.product_name }}
                                    </h3>
                                    {% if item.variant_details %}
                                        <p class="text-xs sm:text-sm text-gray-600 mb-2">
                                            {{ item.variant_details }}
                                        </p>
                                    {% endif %}
                                    
                                    <div class="flex items-center justify-between mt-2">
                                        <span class="text-xs sm:text-sm text-gray-600">
                                            Qty: {{ item.quantity }}
                                        </span>
                                        <div class="text-right">
                                            <div class="text-base sm:text-lg font-bold text-gray-900">
                                                ₹{{ item.total_price|floatformat:0 }}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ₹{{ item.unit_price|floatformat:0 }} each
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Order Timeline -->
                <div class="card">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4">
                        Order Timeline
                    </h2>
                    
                    <div class="timeline-container">
                        {% for step in timeline %}
                            <div class="timeline-item {% if step.completed %}completed{% endif %}">
                                <div class="timeline-icon {% if step.completed %}completed{% endif %} {% if step.is_cancelled %}cancelled{% endif %}">
                                    {% if step.icon == 'check-circle' %}
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                    {% elif step.icon == 'truck' %}
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                            <path d="M3 4a1 1 0 011-1h1a1 1 0 011 1v7a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM7.268 4A2 2 0 019.25 2h7.5A2.25 2.25 0 0119 4.25v6.5A2.25 2.25 0 0116.75 13H15a1 1 0 01-1-1V4H7.268z"/>
                                        </svg>
                                    {% elif step.icon == 'x-circle' %}
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                        </svg>
                                    {% endif %}
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-gray-900 text-sm sm:text-base">
                                        {{ step.title }}
                                    </h3>
                                    <p class="text-xs sm:text-sm text-gray-600 mt-1">
                                        {{ step.description }}
                                    </p>
                                    {% if step.date %}
                                        <p class="text-xs text-gray-500 mt-1.5">
                                            {{ step.date|date:"M d, Y \a\t g:i A" }}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Status History -->
                {% if status_updates %}
                    <div class="card">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4">
                            Status History
                        </h2>
                        
                        <div class="space-y-3">
                            {% for update in status_updates %}
                                <div class="border-l-4 border-black pl-4 py-2.5 bg-gray-50 rounded-r-lg">
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
                                        <span class="font-medium text-gray-900 text-sm">
                                            {% if update.old_status %}
                                                {{ update.old_status|capfirst }} → {{ update.new_status|capfirst }}
                                            {% else %}
                                                {{ update.new_status|capfirst }}
                                            {% endif %}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            {{ update.created_at|date:"M d, Y g:i A" }}
                                        </span>
                                    </div>
                                    {% if update.notes %}
                                        <p class="text-xs sm:text-sm text-gray-600 mt-1.5">
                                            {{ update.notes }}
                                        </p>
                                    {% endif %}
                                    {% if update.updated_by %}
                                        <p class="text-xs text-gray-500 mt-1">
                                            By {{ update.updated_by.get_full_name|default:update.updated_by.username }}
                                        </p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-4 sm:space-y-6">
                
                <!-- Order Summary -->
                <div class="card">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">
                        Order Summary
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">
                                Subtotal ({{ order_summary.total_quantity }} items)
                            </span>
                            <span class="font-medium text-gray-900">
                                ₹{{ order_summary.subtotal|floatformat:0 }}
                            </span>
                        </div>
                        
                        {% if order_summary.discount > 0 %}
                            <div class="flex justify-between items-center text-sm text-green-700">
                                <span>Discount</span>
                                <span class="font-medium">-₹{{ order_summary.discount|floatformat:0 }}</span>
                            </div>
                        {% endif %}
                        
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-medium text-gray-900">
                                {% if order_summary.shipping == 0 %}
                                    Free
                                {% else %}
                                    ₹{{ order_summary.shipping|floatformat:0 }}
                                {% endif %}
                            </span>
                        </div>
                        
                        {% if order_summary.tax > 0 %}
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Tax</span>
                                <span class="font-medium text-gray-900">
                                    ₹{{ order_summary.tax|floatformat:0 }}
                                </span>
                            </div>
                        {% endif %}
                        
                        <div class="border-t pt-3 mt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-base font-semibold text-gray-900">Total</span>
                                <span class="text-xl sm:text-2xl font-bold text-gray-900">
                                    ₹{{ order_summary.total|floatformat:0 }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="card">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">
                        Payment Details
                    </h2>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-start gap-2">
                            <span class="text-gray-600">Method</span>
                            <span class="font-medium text-gray-900 text-right capitalize">
                                {{ order.get_payment_method_display }}
                            </span>
                        </div>
                        
                        <div class="flex justify-between items-start gap-2">
                            <span class="text-gray-600">Status</span>
                            <span class="font-medium capitalize {% if order.payment_status == 'paid' %}text-green-700{% elif order.payment_status == 'failed' %}text-red-700{% else %}text-orange-700{% endif %}">
                                {{ order.get_payment_status_display }}
                            </span>
                        </div>
                        
                        {% if order.payment_reference %}
                            <div class="flex justify-between items-start gap-2">
                                <span class="text-gray-600">Reference</span>
                                <span class="font-mono text-xs text-gray-900 text-right break-all">
                                    {{ order.payment_reference }}
                                </span>
                            </div>
                        {% endif %}
                        
                        {% if order.coupon_code %}
                            <div class="flex justify-between items-center gap-2">
                                <span class="text-gray-600">Coupon</span>
                                <span class="font-mono text-xs text-gray-900">
                                    {{ order.coupon_code }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="card">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">
                        Shipping Address
                    </h2>
                    
                    {% if order.shipping_address %}
                        <div class="text-sm space-y-1">
                            <p class="font-medium text-gray-900">
                                {{ order.shipping_address.first_name }} {{ order.shipping_address.last_name }}
                            </p>
                            <p class="text-gray-600">{{ order.shipping_address.address_line_1 }}</p>
                            {% if order.shipping_address.address_line_2 %}
                                <p class="text-gray-600">{{ order.shipping_address.address_line_2 }}</p>
                            {% endif %}
                            <p class="text-gray-600">
                                {{ order.shipping_address.city }}, {{ order.shipping_address.state }} {{ order.shipping_address.postal_code }}
                            </p>
                            <p class="text-gray-600">{{ order.shipping_address.country }}</p>
                            {% if order.shipping_address.phone %}
                                <p class="text-gray-600 mt-2 pt-2 border-t">
                                    <span class="text-gray-500">Phone:</span> {{ order.shipping_address.phone }}
                                </p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500">No shipping address provided</p>
                    {% endif %}
                </div>

                <!-- Delivery Info -->
                {% if delivery_info.tracking_available or delivery_info.estimated_delivery %}
                    <div class="card">
                        <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">
                            Delivery Information
                        </h2>
                        
                        <div class="space-y-3">
                            {% if order.tracking_id %}
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Tracking ID</span>
                                    <p class="font-mono text-sm text-gray-900 break-all">
                                        {{ order.tracking_id }}
                                    </p>
                                </div>
                            {% endif %}
                            
                            {% if order.courier_partner %}
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Courier Partner</span>
                                    <p class="text-sm text-gray-900">{{ order.courier_partner }}</p>
                                </div>
                            {% endif %}
                            
                            {% if delivery_info.estimated_delivery %}
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Estimated Delivery</span>
                                    <p class="text-sm text-gray-900">
                                        {{ delivery_info.estimated_delivery|date:"M d, Y" }}
                                    </p>
                                </div>
                            {% endif %}
                            
                            {% if delivery_info.delivery_date %}
                                <div>
                                    <span class="text-xs text-gray-500 block mb-1">Delivered On</span>
                                    <p class="text-sm text-green-700 font-medium">
                                        {{ delivery_info.delivery_date|date:"M d, Y \a\t g:i A" }}
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

                <!-- Order Notes -->
                {% if order.order_notes %}
                    <div class="card">
                        <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">
                            Order Notes
                        </h2>
                        <p class="text-sm text-gray-600 leading-relaxed">
                            {{ order.order_notes }}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop overflow-y-auto h-full w-full hidden z-50" style="display: none;">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-3">
                    Cancel Order
                </h3>
                <p class="text-sm text-gray-600 mb-6">
                    Are you sure you want to cancel order #{{ order.order_id }}? This action cannot be undone.
                </p>
                
                <div class="flex flex-col-reverse sm:flex-row gap-3">
                    <button onclick="closeCancelModal()" class="btn btn-secondary flex-1">
                        Keep Order
                    </button>
                    <button id="cancelConfirm" class="btn btn-danger flex-1">
                        Yes, Cancel Order
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.ORDER_ID = "{{ order.order_id }}";
</script>

<script>
(function() {
    'use strict';
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            setTimeout(() => modal.classList.remove('hidden'), 10);
            document.body.style.overflow = 'hidden';
        }
    }
    
    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }
    }
    
    window.cancelOrder = function() {
        showModal('cancelModal');
    };
    
    window.closeCancelModal = function() {
        hideModal('cancelModal');
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        const cancelConfirmBtn = document.getElementById('cancelConfirm');
        const modal = document.getElementById('cancelModal');
        
        if (cancelConfirmBtn) {
            cancelConfirmBtn.addEventListener('click', function() {
                const originalText = cancelConfirmBtn.textContent;
                cancelConfirmBtn.disabled = true;
                cancelConfirmBtn.textContent = 'Cancelling...';
                
                fetch('/user_orders/' + window.ORDER_ID + '/cancel/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.success) {
                        closeCancelModal();
                        
                        // Show success message
                        const successDiv = document.createElement('div');
                        successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successDiv.textContent = 'Order cancelled successfully!';
                        document.body.appendChild(successDiv);
                        
                        // Reload after brief delay
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                        throw new Error(data.message || 'Failed to cancel order');
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    alert(error.message || 'Failed to cancel order. Please try again.');
                    cancelConfirmBtn.disabled = false;
                    cancelConfirmBtn.textContent = originalText;
                });
            });
        }
        
        // Close modal on backdrop click
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCancelModal();
                }
            });
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                closeCancelModal();
            }
        });
    });
    
    // Auto-refresh for active orders
    {% if order.status in 'pending,confirmed,processing,shipped' %}
    var statusCheckInterval = setInterval(function() {
        fetch('/orders/' + window.ORDER_ID + '/status/')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Status check failed');
                }
                return response.json();
            })
            .then(function(data) {
                if (data.status) {
                    console.log('Current status:', data.status);
                    var currentStatus = '{{ order.status }}';
                    if (data.status !== currentStatus && 
                        (data.status === 'delivered' || data.status === 'cancelled')) {
                        window.location.reload();
                    }
                }
            })
            .catch(function(error) {
                console.error('Error checking status:', error);
            });
    }, 30000);
    
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
    });
    
    window.addEventListener('beforeunload', function() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
    });
    {% endif %}
})();
</script>
{% endblock %}